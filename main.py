
import os
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, CallbackQueryHandler, ConversationHandler, ContextTypes
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.service import Service
from selenium.common.exceptions import TimeoutException, NoSuchElementException

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª
TOKEN = "7852676274:AAHIx3Q9qFbylmvHKDhbhT5nEpFOFA5i2CM"

# Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
USERNAME, PASSWORD, CALLER_ID = range(3)

# Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹
WEBSITE_URL = "http://sip.vipcaller.net/mbilling/"

# ØªØ­Ø¯ÙŠØ¯ Ù…Ø³Ø§Ø±Ø§Øª Chrome
CHROME_BIN = os.getenv("CHROME_BIN", "/usr/bin/chromium")
CHROME_DRIVER_PATH = os.getenv("CHROME_DRIVER", "/usr/bin/chromedriver")

# ØªØ®Ø²ÙŠÙ† Ø¬Ù„Ø³Ø© Ø§Ù„Ù…ØªØµÙØ­
driver = None

def setup_chrome_options():
    """Ø¥Ø¹Ø¯Ø§Ø¯ Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªØµÙØ­ ÙƒØ±ÙˆÙ…"""
    options = Options()
    options.binary_location = CHROME_BIN
    options.add_argument("--headless")
    options.add_argument("--no-sandbox")
    options.add_argument("--disable-dev-shm-usage")
    options.add_argument("--disable-gpu")
    options.add_argument("--window-size=1920,1080")
    return options

def create_driver():
    """Ø¥Ù†Ø´Ø§Ø¡ Ù…ØªØµÙØ­ Ø¬Ø¯ÙŠØ¯"""
    global driver
    if driver:
        try:
            driver.quit()
        except:
            pass
    options = setup_chrome_options()
    service = Service(executable_path=CHROME_DRIVER_PATH)
    driver = webdriver.Chrome(service=service, options=options)
    driver.implicitly_wait(10)
    return driver

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬ Ø£Ù…Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©"""
    keyboard = [[InlineKeyboardButton("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", callback_data='login')]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(
        'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø®Ø¯Ù…Ø© ØªØºÙŠÙŠØ± Ù…Ø¹Ø±Ù Ø§Ù„Ù…ØªØµÙ„\nØ§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¨Ø¯Ø¡',
        reply_markup=reply_markup
    )

async def login_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"""
    query = update.callback_query
    await query.answer()
    await query.edit_message_text(
        "ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„\n\nØ§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:"
    )
    return USERNAME

async def get_username(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
    context.user_data['username'] = update.message.text
    await update.message.reply_text("ğŸ”‘ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:")
    return PASSWORD

async def get_password(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬ Ø§Ø³ØªÙ„Ø§Ù… ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆÙ…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"""
    try:
        username = context.user_data.get('username')
        password = update.message.text
        
        if not username:
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… /start")
            return ConversationHandler.END
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…ØªØµÙØ­
        driver = create_driver()
        logger.info("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ù†Ø¬Ø§Ø­")
        
        # ÙØªØ­ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        driver.get(WEBSITE_URL)
        logger.info("ØªÙ… ÙØªØ­ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„")
        
        # Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† WebDriverWait
        wait = WebDriverWait(driver, 30)
        
        # Ø§Ù†ØªØ¸Ø§Ø± ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        username_field = wait.until(
            EC.presence_of_element_located((By.ID, "username"))
        )
        logger.info("ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
        username_field.clear()
        username_field.send_keys(username)
        
        # Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        password_field = driver.find_element(By.ID, "password")
        password_field.clear()
        password_field.send_keys(password)
        logger.info("ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„")
        
        # Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        login_button = driver.find_element(By.ID, "login-button")
        login_button.click()
        logger.info("ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„")
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¬Ø§Ø­ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        try:
            # Ø§Ù†ØªØ¸Ø§Ø± Ø¸Ù‡ÙˆØ± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
            dashboard = wait.until(
                EC.presence_of_element_located((By.ID, "dashboard"))
            )
            logger.info("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­")
            await update.message.reply_text(
                "âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!\n\n"
                "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…ØªØµÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯:"
            )
            return CALLER_ID
        except TimeoutException:
            logger.error("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…")
            await update.message.reply_text(
                "âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„\n"
                "ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
            )
            return ConversationHandler.END
            
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: {str(e)}")
        await update.message.reply_text(
            "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹\n"
            "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹"
        )
        return ConversationHandler.END
    
    finally:
        if driver:
            driver.quit()
            logger.info("ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­")

async def change_caller_id(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬ ØªØºÙŠÙŠØ± Ù…Ø¹Ø±Ù Ø§Ù„Ù…ØªØµÙ„"""
    try:
        new_caller_id = update.message.text
        driver = create_driver()
        wait = WebDriverWait(driver, 30)
        
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø­Ù‚Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…ØªØµÙ„
        caller_id_field = wait.until(
            EC.element_to_be_clickable((By.ID, "caller-id"))
        )
        caller_id_field.clear()
        caller_id_field.send_keys(new_caller_id)
        
        # Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        save_button = wait.until(
            EC.element_to_be_clickable((By.ID, "save-button"))
        )
        save_button.click()
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        success_message = wait.until(
            EC.presence_of_element_located((By.CLASS_NAME, "success-message"))
        )
        
        await update.message.reply_text(
            f"âœ… ØªÙ… ØªØºÙŠÙŠØ± Ù…Ø¹Ø±Ù Ø§Ù„Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰: {new_caller_id}"
        )
        
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ù…Ø¹Ø±Ù Ø§Ù„Ù…ØªØµÙ„: {str(e)}")
        await update.message.reply_text(
            "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØºÙŠÙŠØ± Ù…Ø¹Ø±Ù Ø§Ù„Ù…ØªØµÙ„\n"
            "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"
        )
    
    finally:
        if driver:
            driver.quit()
    
    return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©"""
    await update.message.reply_text('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©')
    return ConversationHandler.END

def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª"""
    # Ø¥Ù†Ø´Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨ÙˆØª
    application = Application.builder().token(TOKEN).build()
    
    # Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    conv_handler = ConversationHandler(
        entry_points=[
            CommandHandler('start', start),
            CallbackQueryHandler(login_button, pattern='^login$')
        ],
        states={
            USERNAME: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, get_username)
            ],
            PASSWORD: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, get_password)
            ],
            CALLER_ID: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, change_caller_id)
            ],
        },
        fallbacks=[CommandHandler('cancel', cancel)],
        per_message=True
    )
    
    # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬
    application.add_handler(conv_handler)
    
    # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
    application.run_polling()

if __name__ == '__main__':
    main()
